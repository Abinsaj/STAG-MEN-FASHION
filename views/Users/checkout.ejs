<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Male_Fashion Template">
    <meta name="keywords" content="Male_Fashion, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Male-Fashion | Template</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Css Styles -->
    <link rel="stylesheet" href="/public/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/public/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/public/css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="/public/css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="/public/css/nice-select.css" type="text/css">
    <link rel="stylesheet" href="/public/css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="/public/css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="/public/css/style.css" type="text/css">
    <link rel="stylesheet" href="/public/assets/css/maind134.css?v=3.4">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include Bootstrap JavaScript after jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


</head>
<style>
    input[type="radio"] {
        transform: scale(0.99);
        /* Adjust the scale to reduce the size to 1/4 */
        /* margin-left: 40pxpx; Adjust the margin to move the radio button to the left */
        padding-right: 20px;
    }
</style>

<body>
    <!-- Page Preloder -->
    <div id="preloder">
        <div class="loader"></div>
    </div>

    <!-- Offcanvas Menu Begin -->
    <div class="offcanvas-menu-overlay"></div>
    <div class="offcanvas-menu-wrapper">
        <div class="offcanvas__option">
            <div class="offcanvas__links">
                <% if(userID){%>
                    <a href="/logout">Log out</a>
                    <%} else { %>
                        <a href="login">Log in</a>
                        <%}%>
                            <a href="#">FAQs</a>
            </div>
            <div class="offcanvas__top__hover">
                <%if(userID){%>
                    <a href="/profile">
                        <span>Profile <i class="arrow_carrot"></i></span>
                    </a>
                    <%} else {%>
                        <a href="login"></a>
                        <% } %>
            </div>
        </div>
        <div class="offcanvas__nav__option">
            <a href="#" class="search-switch"><img src="/public/img/icon/search.png" alt=""></a>
            <a href="#"><img src="/public/img/icon/heart.png" alt=""></a>
            <a href="/cart"><img src="/public/img/icon/cart.png" alt=""> <span>0</span></a>
            <div class="price"></div>
        </div>
        <div id="mobile-menu-wrap"></div>
        <div class="offcanvas__text">
            <p>Free shipping, 30-day return or refund guarantee.</p>
        </div>
    </div>
    <!-- Offcanvas Menu End -->

    <!-- Header Section Begin -->
    <header class="header">
        <div class="header__top">
            <div class="container">
                <div class="row">
                    <div class="col-lg-6 col-md-7">
                        <div class="header__top__left">
                            <p>Free shipping, 30-day return or refund guarantee.</p>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-5">
                        <div class="header__top__right">
                            <div class="header__top__links">
                                <% if(userID){%>
                                    <a href="/logout">Log out</a>
                                    <%} else { %>
                                        <a href="login">Log in</a>
                                        <%}%>
                                            <a href="#">FAQs</a>
                            </div>
                            <div class="header__top__hover">
                                <%if(userID){%>
                                    <a href="/profile">
                                        <span>Profile <i class="arrow_carrot"></i></span>
                                    </a>
                                    <%} else {%>
                                        <a href="login"></a>
                                        <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-md-3">
                    <div class="header__logo">
                        <a href="./index.html"><img src="/public/img/logo.png" alt=""></a>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6">
                    <nav class="header__menu mobile-menu">
                        <ul>
                            <li><a href="/">Home</a></li>
                            <li class="active"><a href="./shop.html">Shop</a></li>
                            <li><a href="#">Pages</a>
                                <ul class="dropdown">
                                    <li><a href="./about.html">About Us</a></li>
                                    <li><a href="./shop-details.html">Shop Details</a></li>
                                    <li><a href="./shopping-cart.html">Shopping Cart</a></li>
                                    <li><a href="./checkout.html">Check Out</a></li>
                                    <li><a href="./blog-details.html">Blog Details</a></li>
                                </ul>
                            </li>
                            <li><a href="./blog.html">Blog</a></li>
                            <li><a href="./contact.html">Contacts</a></li>
                        </ul>
                    </nav>
                </div>
                <div class="col-lg-3 col-md-3">
                    <div class="header__nav__option">
                        <a href="#" class="search-switch"><img src="/public/img/icon/search.png" alt=""></a>
                        <a href="#"><img src="/public/img/icon/heart.png" alt=""></a>
                        <a href="#"><img src="/public/img/icon/cart.png" alt=""> <span>0</span></a>
                        <div class="price">$0.00</div>
                    </div>
                </div>
            </div>
            <div class="canvas__open"><i class="fa fa-bars"></i></div>
        </div>
    </header>
    <!-- Header Section End -->

    <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__text">
                        <h4>Check Out</h4>
                        <div class="breadcrumb__links">
                            <a href="./index.html">Home</a>
                            <a href="./shop.html">Shop</a>
                            <span>Check Out</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->

    <!-- Checkout Section Begin -->
    <main class="main">
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">
                    <!-- <div class="col-lg-6 mb-sm-15">
                    <div class="toggle_info">
                        <span><i class="fi-rs-user mr-10"></i><span class="text-muted">Already have an account?</span> <a href="#loginform" data-bs-toggle="collapse" class="collapsed" aria-expanded="false">Click here to login</a></span>
                    </div>
                    <div class="panel-collapse collapse login_form" id="loginform">
                        <div class="panel-body">
                            <p class="mb-30 font-sm">If you have shopped with us before, please enter your details below. If you are a new customer, please proceed to the Billing &amp; Shipping section.</p>
                            <form method="post">
                                <div class="form-group">
                                    <input type="text" name="email" placeholder="Username Or Email">
                                </div>
                                <div class="form-group">
                                    <input type="password" name="password" placeholder="Password">
                                </div>
                                <div class="login_footer form-group">
                                    <div class="chek-form">
                                        <div class="custome-checkbox">
                                            <input class="form-check-input" type="checkbox" name="checkbox" id="remember" value="">
                                            <label class="form-check-label" for="remember"><span>Remember me</span></label>
                                        </div>
                                    </div>
                                    <a href="#">Forgot password?</a>
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-md" name="login">Log in</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div> -->
                    <div class="col-lg-6">
                        <div class="toggle_info">
                            <span><i class="fi-rs-label mr-10"></i><span class="text-muted">Have a coupon?</span> <a
                                    href="#coupon" data-bs-toggle="collapse" class="collapsed"
                                    aria-expanded="false">Click here to enter your code</a></span>
                        </div>
                        <div class="panel-collapse collapse coupon_form " id="coupon">
                            <div class="panel-body">
                                <h2 >Coupons</h2>
                                <% coupon.forEach(el=>{%>
                                    <div class="card-body">
                                        <p class="card-text mb-3">
                                            <%=el.name %>
                                        </p>
                                        <button type="submit">
                                            <%=el.couponcode %>
                                        </button>
                                        <p class="card-text mb-30">
                                            <%= new Date(el.expiryDate).toLocaleDateString() %>
                                        </p>
                                    </div>
                                    <% }) %>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="divider mt-50 mb-50"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="content-header">
                            <div>
                                <h2 class="content-title card-title">Billing Address</h2>
                            </div>
                            <div>
                                <a href="/addaddress" class="btn btn-md rounded font-sm">Add</a>
                            </div>                
                        </div>
                        <br>
                        <% if (locals.uadd) { %>
                            <% uadd.forEach((element, index)=> { %>
                                <div class="card mb-3 mb-lg-0">
                                    <div class="card-header d-flex align-items-center">
                                        <h5 class="mb-0 ms-2">Address</h5>
                                        <div style="margin-left: -20px, ;">
                                            <input type="radio" class="radiobtn" name="address"
                                                id="address<%= element._id %>" value="<%= element._id %>" <%=index===0
                                                ? 'checked' : '' %>>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <address>
                                            <%= element.name %><br>
                                                <%= element.mobile %><br>
                                                    <%= element.locality %><br>
                                                        <%= element.Address %><br>
                                                            <%= element.city %><br>
                                                                <%= element.state %><br>
                                                                    <%= element.country %>
                                        </address>
                                    </div>
                                    <div class="text-end mt-3">
                                        <a href="#">
                                            <button class="btn rounded font-sm"
                                                style="background-color: rgba(0, 0, 0, 0.03),text;">EDIT</button>
                                        </a>
                                    </div>
                                </div>
                                <br>
                                <% }) %>
                                    <% } %>

                    </div>
                    <div class="col-md-6">
                        <div class="order_review">
                            <div class="mb-20">
                                <h4>Your Orders</h4>
                            </div>
                            <div class="table-responsive order_table text-center">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th colspan="2">Product</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>

                                        <tr>
                                            <% if(locals.ucart){%>
                                                <% ucart.items.forEach(element=> {%>
                                                    <td class="image product-thumbnail"><img
                                                            src="/uploads/<%= element.productID.image[0] %>" alt="#">
                                                    </td>
                                                    <td>
                                                        <h5><a href="shop-product-full.html">
                                                                <%= element.productID.name %>
                                                            </a></h5> <span class="product-qty">
                                                            <%= element.quantity %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <%= element.price %>
                                                    </td>
                                        </tr>
                                        <%})%>
                                            <%}%>
                                                <tr>
                                                    <th>SubTotal</th>
                                                    <td class="product-subtotal" colspan="2">RS:<%= ucart.totalPrice %>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Shipping</th>
                                                    <td colspan="2"><em>Free Shipping</em></td>
                                                </tr>
                                                <tr>
                                                    <th>Total</th>
                                                    <td colspan="2" class="product-subtotal"><span id="totalprice"
                                                            class="font-xl text-brand fw-900">
                                                            <%= ucart.totalPrice %>
                                                        </span></td>
                                                </tr>

                                    </tbody>
                                    <div class="form-group">
                                        <input type="text" id="coup" placeholder="Enter Coupon Code...">
                                    </div>
                                    <div class="form-group">
                                        <button class="btn  btn-md"
                                            onclick="applyCoupon(`<%= ucart.totalPrice %>`)"
                                            name="">Apply Coupon</button>
                                    </div>
                                </table>
                                
                                   
                                
                            </div>
                            <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                            <div class="payment_method">
                                <div class="mb-25">
                                    <h5>Payment</h5>
                                </div>
                                <div class="payment_option">
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option"
                                            value="COD" id="exampleRadios3" checked="">
                                        <label class="form-check-label" for="exampleRadios3" data-bs-toggle="collapse"
                                            data-target="cashondelivery" aria-controls="bankTranfer">Cash on
                                            Delivery</label>
                                        <div class="form-group collapse in" id="bankTranfer">
                                            <p class="text-muted mt-5">There are many variations of passages of Lorem
                                                Ipsum
                                                available, but the majority have suffered alteration. </p>
                                        </div>
                                    </div>
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option"
                                            value="wallet" id="exampleRadios4" checked="">
                                        <label class="form-check-label" for="exampleRadios4" data-bs-toggle="collapse"
                                            data-target="#checkPayment" aria-controls="checkPayment">Wallet</label>
                                        <div class="form-group collapse in" id="checkPayment">
                                            <p class="text-muted mt-5">Please send your cheque to Store Name, Store
                                                Street,
                                                Store Town, Store State / County, Store Postcode. </p>
                                        </div>
                                    </div>
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option"
                                            value="Razorpay" id="exampleRadios5" checked="">
                                        <label class="form-check-label" for="exampleRadios5" data-bs-toggle="collapse"
                                            data-target="#paypal" aria-controls="paypal">RazorPay</label>
                                        <div class="form-group collapse in" id="paypal">
                                            <p class="text-muted mt-5">Pay via PayPal; you can pay with your credit card
                                                if
                                                you don't have a PayPal account.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button onclick="placeOrder(`<%=ucart._id %>`)"
                                class="btn btn-fill-out btn-block mt-30">Place
                                Order</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>


    </main>
    <!-- Checkout Section End -->
    <div class="containerabove"></div>
    <!-- Footer Section Begin -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="footer__about">
                        <div class="footer__logo">
                            <a href="#"><img src="/public/img/footer-logo.png" alt=""></a>
                        </div>
                        <p>The customer is at the heart of our unique business model, which includes design.</p>
                        <a href="#"><img src="/public/img/payment.png" alt=""></a>
                    </div>
                </div>
                <div class="col-lg-2 offset-lg-1 col-md-3 col-sm-6">
                    <div class="footer__widget">
                        <h6>Shopping</h6>
                        <ul>
                            <li><a href="#">Clothing Store</a></li>
                            <li><a href="#">Trending Shoes</a></li>
                            <li><a href="#">Accessories</a></li>
                            <li><a href="#">Sale</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <div class="footer__widget">
                        <h6>Shopping</h6>
                        <ul>
                            <li><a href="#">Contact Us</a></li>
                            <li><a href="#">Payment Methods</a></li>
                            <li><a href="#">Delivary</a></li>
                            <li><a href="#">Return & Exchanges</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 offset-lg-1 col-md-6 col-sm-6">
                    <div class="footer__widget">
                        <h6>NewLetter</h6>
                        <div class="footer__newslatter">
                            <p>Be the first to know about new arrivals, look books, sales & promos!</p>
                            <form action="#">
                                <input type="text" placeholder="Your email">
                                <button type="submit"><span class="icon_mail_alt"></span></button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="footer__copyright__text">
                        <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                        <p>Copyright ©
                            <script>
                                document.write(new Date().getFullYear());
                            </script>2020
                            All rights reserved | This template is made with <i class="fa fa-heart-o"
                                aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank">Colorlib</a>
                        </p>
                        <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- Footer Section End -->

    <!-- Search Begin -->
    <div class="search-model">
        <div class="h-100 d-flex align-items-center justify-content-center">
            <div class="search-close-switch">+</div>
            <form class="search-model-form">
                <input type="text" id="search-input" placeholder="Search here.....">
            </form>
        </div>
    </div>
    <!-- Search End -->
    <script>
        let radiovalue;
        async function placeOrder(cartID, radiovalue) {
            const radiobtn = document.querySelectorAll('.radiobtn')
            const paymentMethod = document.querySelector('input[name="payment_option"]:checked').value;
            const TPrice = document.getElementById('totalprice')
            const totalPrice = TPrice.textContent
            const coupon = document.getElementById('coup').value

            radiobtn.forEach(element => {

                if (element.checked) {
                    radiovalue = element.value;
                }

            })

            if (radiovalue !== undefined) {
                if (paymentMethod == 'Razorpay') {
                    fetch('/createorder', {
                        method: 'post',
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ cartID, totalPrice })
                    })
                        .then(response => response.json())
                        .then(data => {
                            const parsedAmount = parseInt(totalPrice)
                            const options = {
                                "key": "rzp_test_lTepvaZWAfuQBF", // Enter the Key ID generated from the Dashboard
                                "amount": 1000000, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                                "currency": "INR",
                                "name": "STAG MEN FASHION",
                                "description": "Test Transaction",
                                "image": "https://example.com/your_logo",
                                "order_id": data.orderID.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                                "handler": function (response) {
                                    alert(response.razorpay_payment_id);
                                    alert(response.razorpay_order_id);
                                    alert(response.razorpay_signature)
                                    verify(response, data.orderID.id)
                                },
                                "prefill": {
                                    "name": "Gaurav Kumar",
                                    "email": "gaurav.kumar@example.com",
                                    "contact": "9000090000"
                                },
                                "notes": {
                                    "address": "Razorpay Corporate Office"
                                },
                                "theme": {
                                    "color": "#3399cc"
                                }
                            }
                            var rzp = new Razorpay(options);
                            rzp.open();

                            async function verify(response, orderid) {
                                fetch('/paymentsuccess', {
                                    method: 'post',
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify({
                                        paymentid: response.razorpay_payment_id,
                                        razorpayorderid: response.razorpay_order_id,
                                        signature: response.razorpay_signature,
                                        orderid
                                    })

                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            fetch('/cod', {
                                                method: 'post',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                },
                                                body: JSON.stringify({ cartID, radiovalue, paymentMethod: "razorpay", totalPrice, coupon })
                                            })
                                                .then(response => response.json())
                                                .then(data => {
                                                    if (data.success == true) {
                                                        window.location.href = '/ordersuccess'
                                                    }
                                                })
                                        }
                                    })
                            }
                        })
                } else
                    if (paymentMethod == 'COD') {
                        fetch('/cod', {
                            method: 'post',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ cartID, radiovalue, paymentMethod, totalPrice, coupon })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success == true) {
                                    window.location.href = '/ordersuccess'
                                }
                            })
                    }
            }
        }


        async function applyCoupon(totalprice) {
            const couponcode = document.getElementById('coup').value
            console.log('iths hereeeeeerrrrr');
            console.log('the coupon code is:',couponcode);
            console.log('the total price is :',totalprice);

            fetch('/applycoupon', {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ couponcode, totalprice })
            })
                .then(response => response.json())
                .then((data) => {
                    if (data.success) {
                        console.log(data.discounted);
                        // const discountTotal = data.discounted
                        Swal.fire({
                            icon: 'success',
                            title: 'Coupon Applied Successfully!',
                            text: `Discount: ${data.discount}%\nDiscounted Total: RS ${data.discounted}`,
                        });
                        const totalPriceElement = document.getElementById('totalprice')
                        totalPriceElement.textContent = `${data.discounted}`;
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Coupon Application Failed',
                            text: data.message,
                        });
                    }
                })
        }
    </script>
    <!-- Js Plugins -->
    <script src="/public/js/jquery-3.3.1.min.js"></script>
    <script src="/public/js/bootstrap.min.js"></script>
    <script src="/public/js/jquery.nice-select.min.js"></script>
    <script src="/public/js/jquery.nicescroll.min.js"></script>
    <script src="/public/js/jquery.magnific-popup.min.js"></script>
    <script src="/public/js/jquery.countdown.min.js"></script>
    <script src="/public/js/jquery.slicknav.js"></script>
    <script src="/public/js/mixitup.min.js"></script>
    <script src="/public/js/owl.carousel.min.js"></script>
    <script src="/public/js/main.js"></script>
</body>

</html>